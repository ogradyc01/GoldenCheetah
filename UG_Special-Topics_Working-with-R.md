#Using the R Chart

The R chart is introduced with v4.0 of GoldenCheetah. The chart can be added to the activity view and the trend view.

In trend view the chart is refreshed when a date range or season is selected, or if the compare pane is updated. Whilst in the activity view the chart is refreshed when an activity is selected or, again, if the compare pane for intervals is updated.

When the chart is refreshed the user supplied R script is executed, and it should collect data and prepare a plot.

A simple example to plot HR might be:

```
> ride <- GC.activity()
> plot(ride$heart.rate)
```
This basically calls a GC function to fetch the data for the current ride and then uses the base R plot function to plot heart rate as a time series.

Similarly, in trend view, to plot a simple time series of average power for the current season:

```
> metrics <- GC.metrics()
> plot(metrics$Average_Power)
```

**Compare Mode**

Where applicable the data access routines will offer a 'compare' parameter to access data; if FALSE it just returns the currently selected ride, if TRUE it will return a list. If compare mode is not active then the list will contain only one set of data for the currently selected ride. If compare is active it returns a list of all things being compared. See GC.activity(compare=TRUE) below for an example.

##GC methods available in an R chart

All methods to access and work with GC objects and data within an R chart are prefixed with "GC." this is to ensure there is no namespace clash with other packages you may have installed. There are a number of methods available as listed below.

###GC.build() and GC.version()

GC.build will return the build number which increments with each release (including pre-release development builds), you can use this if you need to make a script dependant on the build. Additionally, GC.version will return a string describing the release,which could be put in files or on screen etc.

e.g:
```
> GC.build()
[1] 3941
> GC.version()
[1] "V4.0 DEV1604"
> 
```

###GC.athlete() and GC.athlete.home()

GC.athlete() will return a character string representing the current athlete, whilst GC.athlete.home() will return the full path to the athlete home directory, so you can read/write files stored there or add your own subdirectory or data files to use within a chart.

e.g.
```
> GC.athlete()
[1] "Mark Liversedge"
> GC.athlete.home()
[1] "/home/markl/Athletes/Mark Liversedge"
> 
```

###GC.activities()

Will return a vector of POSIXct datetimes representing the start time for each activity. As the API matures it is expected that you will be able to reference a specific athletes activity via its start time.

e.g.
```
> d <- GC.activities()
> str(d)
 POSIXct[1:705], format: "2005-06-25 14:26:00" "2005-06-27 08:39:00" ...
> 
```

###GC.activity(compare=FALSE)

By default (compare=FALSE) it will return a data.frame representing the data for the currently selected ride. The column names have been selected to remain compatible with the trackeR package from UCL for analysing GPS based sports data.

The data.frame returned looks like this when using the 'str' command:

```
R Console (3.3.0)
> df <- GC.activity()
> str(df)
'data.frame':	3713 obs. of  21 variables:
 $ time        : POSIXct, format: "2016-05-04 15:00:19" "2016-05-04 15:00:20" ...
 $ seconds     : num  0 1 2 3 4 5 6 7 8 9 ...
 $ cadence     : num  0 0 0 0 0 0 0 0 0 0 ...
 $ cadenced    : num  0 0 0 0 0 0 0 0 0 0 ...
 $ heart.rate  : num  NA NA NA NA NA NA NA NA NA NA ...
 $ heart.rated : num  NA NA NA NA NA NA NA NA NA NA ...
 $ distance    : num  0 0 0 0 0 0 0 0 0 0 ...
 $ speed       : num  5.1 5.1 5.38 5.65 5.93 ...
 $ acceleration: num  0 0 0.0772 0.0772 0.0772 ...
 $ torque      : num  NA NA NA NA NA NA NA NA NA NA ...
 $ torqued     : num  NA NA NA NA NA NA NA NA NA NA ...
 $ power       : num  0 0 0 0 0 0 0 0 0 0 ...
 $ powerd      : num  0 0 0 0 0 0 0 0 0 0 ...
 $ altitude    : num  66 66 66 66 66 66 66 66 66 66 ...
 $ longitude   : num  -0.479 -0.479 -0.479 -0.479 -0.479 ...
 $ latitude    : num  51.1 51.1 51.1 51.1 51.1 ...
 $ headwind    : num  5.1 5.1 5.38 5.65 5.93 ...
 $ slope       : num  0 0 0 0 0 0 0 0 0 0 ...
 $ temperature : num  27 27 27 27 27 27 27 27 27 27 ...
 $ apower      : num  0 0 0 0 0 0 0 0 0 0 ...
 $ gearratio   : num  0 0 0 0 0 0 0 0 0 0 ...
> 
```

Depending upon the data you have available in the activity you may see more columns, for example pedal based power meters and muscle oxygen devices will return additional data. In this example above you will see that heartrate and torque data is not recorded but still present in the data.frame -- the columns listed above will always be made available but will contan R's NA value if not actually recorded in the activity.

**GC.activity(compare=TRUE)**

If you pass the parameter compare=TRUE then the format returned is a list rather than a dataframe. The lis contains an entry for each ride being compared, or just the currently selected ride if compare is not active.

Each entry in the list contains two elements; 'color' a string you can use in 'col="xxx"' assignments, and 'activity' the data.frame in the same format as above.

e.g. with compare **not** active:

```
> df <- GC.activity(compare=TRUE)
> str(df)
Dotted pair list of 1
 $ :Dotted pair list of 2
  ..$ activity:'data.frame':	3713 obs. of  21 variables:
  .. ..$ time        : POSIXct[1:3713], format: "2016-05-04 15:00:19" "2016-05-04 15:00:20" ...
  .. ..$ seconds     : num [1:3713] 0 1 2 3 4 5 6 7 8 9 ...
  .. ..$ cadence     : num [1:3713] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ cadenced    : num [1:3713] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ heart.rate  : num [1:3713] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ heart.rated : num [1:3713] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ distance    : num [1:3713] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ speed       : num [1:3713] 5.1 5.1 5.38 5.65 5.93 ...
  .. ..$ acceleration: num [1:3713] 0 0 0.0772 0.0772 0.0772 ...
  .. ..$ torque      : num [1:3713] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ torqued     : num [1:3713] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ power       : num [1:3713] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ powerd      : num [1:3713] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ altitude    : num [1:3713] 66 66 66 66 66 66 66 66 66 66 ...
  .. ..$ longitude   : num [1:3713] -0.479 -0.479 -0.479 -0.479 -0.479 ...
  .. ..$ latitude    : num [1:3713] 51.1 51.1 51.1 51.1 51.1 ...
  .. ..$ headwind    : num [1:3713] 5.1 5.1 5.38 5.65 5.93 ...
  .. ..$ slope       : num [1:3713] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ temperature : num [1:3713] 27 27 27 27 27 27 27 27 27 27 ...
  .. ..$ apower      : num [1:3713] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ gearratio   : num [1:3713] 0 0 0 0 0 0 0 0 0 0 ...
  ..$ color   : chr "#FF00FF"
> 
```

e.g. with compare active and two rides in the compare pane:

```
> df <- GC.activity(compare=TRUE)
> str(df)
Dotted pair list of 2
 $ :Dotted pair list of 2
  ..$ activity:'data.frame':	3712 obs. of  21 variables:
  .. ..$ time        : POSIXct[1:3712], format: "2016-05-04 15:00:19" "2016-05-04 15:00:20" ...
  .. ..$ seconds     : num [1:3712] 0 1 2 3 4 5 6 7 8 9 ...
  .. ..$ cadence     : num [1:3712] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ cadenced    : num [1:3712] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ heart.rate  : num [1:3712] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ heart.rated : num [1:3712] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ distance    : num [1:3712] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ speed       : num [1:3712] 5.1 5.1 5.38 5.65 5.93 ...
  .. ..$ acceleration: num [1:3712] 0 0 0.0772 0.0772 0.0772 ...
  .. ..$ torque      : num [1:3712] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ torqued     : num [1:3712] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ power       : num [1:3712] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ powerd      : num [1:3712] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ altitude    : num [1:3712] 66 66 66 66 66 66 66 66 66 66 ...
  .. ..$ longitude   : num [1:3712] -0.479 -0.479 -0.479 -0.479 -0.479 ...
  .. ..$ latitude    : num [1:3712] 51.1 51.1 51.1 51.1 51.1 ...
  .. ..$ headwind    : num [1:3712] 5.1 5.1 5.38 5.65 5.93 ...
  .. ..$ slope       : num [1:3712] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ temperature : num [1:3712] 27 27 27 27 27 27 27 27 27 27 ...
  .. ..$ apower      : num [1:3712] 0 0 0 0 0 0 0 0 0 0 ...
  .. ..$ gearratio   : num [1:3712] 0 0 0 0 0 0 0 0 0 0 ...
  ..$ color   : chr "#ff00ff"
 $ :Dotted pair list of 2
  ..$ activity:'data.frame':	4534 obs. of  21 variables:
  .. ..$ time        : POSIXct[1:4534], format: "2016-05-03 14:45:57" "2016-05-03 14:45:58" ...
  .. ..$ seconds     : num [1:4534] 0 1 2 3 4 5 6 7 8 9 ...
  .. ..$ cadence     : num [1:4534] 78 71 72 133 133 133 60 93 93 93 ...
  .. ..$ cadenced    : num [1:4534] 0 0 1 61 0 0 0 33 0 0 ...
  .. ..$ heart.rate  : num [1:4534] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ heart.rated : num [1:4534] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ distance    : num [1:4534] 0 0.006 0.012 0.012 0.012 0.014 0.02 0.02 0.02 0.02 ...
  .. ..$ speed       : num [1:4534] 0 24.8 30.7 30.7 30.7 ...
  .. ..$ acceleration: num [1:4534] 0 6.89 1.64 0 0 ...
  .. ..$ torque      : num [1:4534] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ torqued     : num [1:4534] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ power       : num [1:4534] 0 34 20 0 0 0 11 11 11 11 ...
  .. ..$ powerd      : num [1:4534] 0 34 0 0 0 0 11 0 0 0 ...
  .. ..$ altitude    : num [1:4534] -33 -32 -32 -32 -32 -32 -32 -32 -32 -32 ...
  .. ..$ longitude   : num [1:4534] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ latitude    : num [1:4534] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ headwind    : num [1:4534] 0 24.8 30.7 30.7 30.7 ...
  .. ..$ slope       : num [1:4534] 0 16.7 0 0 0 ...
  .. ..$ temperature : num [1:4534] 17 18 18 18 18 18 18 18 18 18 ...
  .. ..$ apower      : num [1:4534] 0 34 20 0 0 0 11 11 11 11 ...
  .. ..$ gearratio   : num [1:4534] 0 2.7 3 3 3 3 3.5 2.3 2.3 2.3 ...
  ..$ color   : chr "#00ffff"
> 
```

In this way, if you want to remain compatible with compare mode when charting you should always use 'compare=TRUE' and loop through the results to plot, taking care to overplot using 'lines', 'points' or 'curve'.

Here is a script that plots density distributions for power and is compatible with compare mode:
```
## R script will run on selection.
##
## GC.activity(compare=TRUE)
## GC.metrics(all=FALSE)
##
## Get the current ride or metrics
##

# get a list of activities, will have one member
# if not in compare mode, or multiple if we are
# in compare mode
d <- GC.activity(compare=TRUE)

## set plot limits
maxy <-0
maxx <-0

for (compare in d) {

   # get the activity being compared
   power <- compare$activity$power

   # density
   k <- density(power)

   # max on x axis
   mx <- max(power)
   if (mx > maxx) maxx <- mx;

   # max on y axis
   my <- max(k$y)
   if (my > maxy) maxy <- my;
}

## create a blank plot
plot(k, ylim = c(0,maxy), xlim=c(0,maxx), 
     col="black", main="", xlab="", yaxt="n")

title(main="Power Distribution", 
      xlab = "Watts")

## add density
for (compare in d) {

    # just the ride
    power <- compare$activity$power

    k <- density(power)
    if (length(d)==1) lines(k, col="green")
    else lines(k, col=compare$color)
}
```
**As you may have guessed the script in an R chart will be re-run when an activity is selected or compare pane changes (you add or deselect an activity etc).**

##TODO
GC.activity.meanmax(compare=)
GC.activity.wbal(compare=)
GC.metrics(all, compare)
GC.pmc(all, metric)
